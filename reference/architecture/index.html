<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="generator" content="Hugo 0.53" />
    <meta name="description" content="Documentation for umoci -- a tool for modifying OCI images.">
<meta name="author" content="Aleksa Sarai">

    <link rel="shortcut icon" href="/images/favicon.png" type="image/x-icon" />
<link rel="icon" href="/images/favicon.png" type="image/x-icon" />

    <title>Architecture :: umoci</title>
    
    
    <link href="/css/nucleus.css?1545902654" rel="stylesheet">
    <link href="/css/font-awesome.min.css?1545902654" rel="stylesheet">
    <link href="/css/hybrid.css?1545902654" rel="stylesheet">
    <link href="/css/featherlight.min.css?1545902654" rel="stylesheet">
    <link href="/css/perfect-scrollbar.min.css?1545902654" rel="stylesheet">
    <link href="/css/auto-complete.css?1545902654" rel="stylesheet">
    <link href="/css/theme.css?1545902654" rel="stylesheet">
    <link href="/css/hugo-theme.css?1545902654" rel="stylesheet">
    
      <link href="/css/theme-green.css?1545902654" rel="stylesheet">
    

    <script src="/js/jquery-2.x.min.js?1545902654"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
        :not(pre) > code + span.copy-to-clipboard {
            display: none;
        }
      
    </style>
    
  </head>
  <body class="" data-url="/reference/architecture/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="/"><img src="/umoci-white.png" width="70%"/></a>

    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fa fa-search"></i></label>
    <input data-search-input id="search-by" type="text" placeholder="Search...">
    <span data-search-clear=""><i class="fa fa-close"></i></span>
</div>

<script type="text/javascript" src="/js/lunr.min.js?1545902654"></script>
<script type="text/javascript" src="/js/auto-complete.js?1545902654"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/umo.ci\/";
    
</script>
<script type="text/javascript" src="/js/search.js?1545902654"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/quick-start/" title="Basics" class="dd-item 
        
        
        
        ">
      <a href="/quick-start/">
          Basics
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/quick-start/getting-an-image/" title="Getting an Image" class="dd-item ">
        <a href="/quick-start/getting-an-image/">
        Getting an Image
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/workflow/" title="Workflow" class="dd-item ">
        <a href="/quick-start/workflow/">
        Workflow
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/creating-an-image/" title="Creating an Image" class="dd-item ">
        <a href="/quick-start/creating-an-image/">
        Creating an Image
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/garbage-collection/" title="Garbage Collection" class="dd-item ">
        <a href="/quick-start/garbage-collection/">
        Garbage Collection
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/quick-start/rootless/" title="Rootless Containers" class="dd-item ">
        <a href="/quick-start/rootless/">
        Rootless Containers
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/advanced/" title="Advanced" class="dd-item 
        
        
        
        ">
      <a href="/advanced/">
          Advanced
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/advanced/workflow-optimisation/" title="Workflow Optimisation" class="dd-item ">
        <a href="/advanced/workflow-optimisation/">
        Workflow Optimisation
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/reference/" title="Reference" class="dd-item 
        parent
        
        
        ">
      <a href="/reference/">
          Reference
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/reference/roadmap/" title="Roadmap" class="dd-item ">
        <a href="/reference/roadmap/">
        Roadmap
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/architecture/" title="Architecture" class="dd-item active">
        <a href="/reference/architecture/">
        Architecture
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/reference/security/" title="Security Considerations" class="dd-item ">
        <a href="/reference/security/">
        Security Considerations
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    
      <section id="shortcuts">
        <h3>More</h3>
        <ul>
          
              <li class="" role=""> 
                  <a class="padding" href="https://github.com/openSUSE/umoci"><i class='fa fa-git'></i> Source Code</a>
              </li>
          
        </ul>
      </section>
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fa fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable sticky-parent">
              
              <div class="sticky-spacer">
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fa fa-list-alt"></i></span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='/'>Home</a> > <a href='/reference/'>Reference</a> > Architecture
          
         
          
         
          
           
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#manifests">Manifests</a></li>
<li><a href="#mutation">Mutation</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            

        
        <div id="body-inner">
          
            <h1>Architecture</h1>
          

        




<p>umoci is a fairly simple tool, that takes advantage of a couple of tricks in
order to allow for modification of OCI images. This architecture document is
fairly high-level and will likely change once some more of the
<a href="/doc/roadmap.md">roadmap</a> is implemented. If you feel something is missing from
this document, feel free to <a href="/contributing">contribute</a>.</p>

<p>When umoci was first released, I also published <a href="https://www.cyphar.com/blog/post/umoci-new-oci-image-tool">a blog post</a> outlying
the original architecture (which has remained fairly similar over time).</p>

<h3 id="manifests">Manifests</h3>

<p>The key feature of umoci is that it allows for generation of delta layers
without the need for copies of the original root filesystem or fancy filesystem
features (such as snapshots or overlays). As a result, the design is applicable
to any modern Unix-like operating system.</p>

<p>This feature is implemented through the use of manifest files. In particular,
[<code>mtree(8)</code> manifests][mtree(5)]. After extraction of the root filesystem has
been completed, a full manifest is generated from the root filesystem. When
wanting to generate a delta layer, a new manifest is generated and the two
manifests are compared. Any inconsistencies are then added to the delta layer.</p>

<p>By using this very simple (and quite old) technique, we can create delta layers
without the need for copies of the original filesystem or fancy filesystems.</p>

<h3 id="mutation">Mutation</h3>

<p>The main purpose of umoci is the ability to modify an image in various ways
(by changing the configuration or adding delta layers).</p>

<p>At the core of an OCI image is a content-addressable blob store, with different
types of blobs signifying important data or metadata about an image contained
in the store. As all blobs (both the metadata and data) are
content-addressable, it does not make sense to talk about &ldquo;modifying&rdquo; a blob.</p>

<p>Instead, what umoci does is that it creates a new version of a blob that is
being replaced. Then, umoci walks up the referencing path that it took to
reach the replaced blob and replaces all of the blobs that reference the old
blob with a new blob referencing the new blob. This replacement will result in
further changes to parents until the change bubbles up to the root
<code>index.json</code>. Then, umoci will create or replace a top-level <code>index.json</code>
entry to point to the newly created tree. Note that umoci will not replace
any blobs that were not in the ancestor path of the modification, which means
that all of the unchanged blobs are necessarily de-duplicated (and any other
references to the old blob remain intact).</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="/reference/roadmap/" title="Roadmap"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="/reference/security/" title="Security Considerations" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/js/clipboard.min.js?1545902654"></script>
    <script src="/js/perfect-scrollbar.min.js?1545902654"></script>
    <script src="/js/perfect-scrollbar.jquery.min.js?1545902654"></script>
    <script src="/js/jquery.sticky-kit.min.js?1545902654"></script>
    <script src="/js/featherlight.min.js?1545902654"></script>
    <script src="/js/html5shiv-printshiv.min.js?1545902654"></script>
    <script src="/js/highlight.pack.js?1545902654"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/js/modernizr.custom.71422.js?1545902654"></script>
    <script src="/js/learn.js?1545902654"></script>
    <script src="/js/hugo-learn.js?1545902654"></script>

    <link href="/mermaid/mermaid.css?1545902654" type="text/css" rel="stylesheet" />
    <script src="/mermaid/mermaid.js?1545902654"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

